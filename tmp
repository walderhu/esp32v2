import uasyncio as asyncio
import logging
from network import WLAN, STA_IF
from uaioftp import uaioftpd
from machine import Pin
from config import ssid, password

log = logging.getLogger(__name__)

async def blink(*, led=Pin(2, Pin.OUT), delay=0.05, flash=0.05, repeat=3):
    for _ in range(repeat):
        led.on()
        await asyncio.sleep(flash)
        led.off()
        await asyncio.sleep(delay)


async def connect_wifi(delay=1, *, dots=0):
    wlan = WLAN(STA_IF)
    wlan.active(True)
    while True:
        try:
            wlan.connect(ssid, password)
            while not wlan.isconnected():
                dots = (dots + 1) % 4  
                log.info(f' Wi-Fi{"." * dots}\033[K', end='\r')
                await asyncio.sleep(delay)  
            else:
                await blink(repeat=2)
                log.info(f'rssi = {wlan.status("rssi")}')
                return wlan.ifconfig()[0]
        except Exception as e:
            log.info(f" Ошибка подключения к Wi-Fi: {e}\033[K", end='\r')
            await asyncio.sleep(delay)  
        

async def run_server():
    port=21
    ip = await connect_wifi()
    ftpd = uaioftpd(my_ip=ip)
    server = await asyncio.start_server(ftpd.server, '0.0.0.0', port)
    async with server:
        log.info(f"Запуск сервера: {ip} {port}")
        while True:
            await blink(repeat=1, delay=3, flash=.1)
            log.info(end='\r')

    
async def status_log(delay=0.5, dots=0):
    while True:
        dots = (dots + 1) % 4  
        log.info(f' Server works{"." * dots}\033[K', end='\r')
        await asyncio.sleep(delay)


async def main():
    try: await run_server()
    except Exception as e: log.info(e)
        
if __name__ == '__main__':
    try: asyncio.run(main())
    except KeyboardInterrupt as e: log.info(f"Программа прервана: {e}")
        