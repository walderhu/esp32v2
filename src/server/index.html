<!-- index.html -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Joystick Control</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="container">
        <div class="pad">
            <button class="dir home" data-dir="home">
                <img src="misc/home.svg" alt="home" />
            </button>
            <button class="dir stop" data-dir="stop">
                <img src="misc/stop.svg" alt="Stop" width="32" height="32" />
            </button>
            <button class="dir up" data-dir="up">
                <img src="misc/up.svg" alt="up" width="32" height="32" />
            </button>
            <button class="dir down" data-dir="down">
                <img src="misc/down.svg" alt="down" width="32" height="32" />
            </button>
            <button class="dir left" data-dir="left">
                <img src="misc/left.svg" alt="left" width="32" height="32" />
            </button>
            <button class="dir right" data-dir="right">
                <img src="misc/right.svg" alt="right" width="32" height="32" />
            </button>
        </div>

        <!-- Controls Section -->
        <div class="controls">
            <div class="scale-row">
                <button class="scale-btn" data-scale="0.1">0.1</button>
                <button class="scale-btn" data-scale="1">1</button>
                <button class="scale-btn" data-scale="10">10</button>
                <button class="scale-btn" data-scale="25">25</button>
                <button class="scale-btn selected" data-scale="50">50</button>
                <button class="scale-btn" data-scale="100">100</button>
            </div>

            <div class="columns-row">
                <div class="column">
                    <div class="coord-input">
                        <label><span class="axis">X:</span> <span class="meta">[0.00]</span></label>
                        <input type="number" id="xInput" value="52.91" step="0.01">
                        <span class="unit">мм</span>
                    </div>
                    <div class="speed-input">
                        <label><span class="axis">Скорость</span></label>
                        <input type="number" id="speed" value="10" step="1">
                        <span class="unit">мм/с</span>
                    </div>
                </div>
                <div class="column">
                    <div class="coord-input">
                        <label><span class="axis">Y:</span> <span class="meta">[0.00]</span></label>
                        <input type="number" id="yInput" value="62.03" step="0.01">
                        <span class="unit">мм</span>
                    </div>
                    <div class="speed-input">
                        <label><span class="axis">Длина шага</span></label>
                        <input type="number" id="stepLength" value="5" step="0.1">
                        <span class="unit">мм</span>
                    </div>
                </div>
            </div>

            <button id="zeroBtn" class="zero-btn">Применить</button>
        </div>
    </div>

    <script>
        // Общая функция отправки POST
        const sendPress = (dir, action = "press", value = null) => {
            fetch('/press', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dir, action, value })
            }).catch(e => console.error('Ошибка отправки:', e));

            const btn = document.querySelector('button.dir.' + dir);
            if (btn) {
                if (action === 'press') btn.classList.add('pressed');
                else btn.classList.remove('pressed');
            }
        };

        // Кнопки движения
        document.querySelectorAll('button.dir').forEach(btn => {
            const dir = btn.dataset.dir;
            let isPressed = false;

            const press = () => { if (!isPressed) { sendPress(dir, 'press'); isPressed = true; } };
            const release = () => { if (isPressed) { sendPress(dir, 'release'); isPressed = false; } };

            btn.addEventListener('mousedown', press);
            btn.addEventListener('mouseup', release);
            btn.addEventListener('mouseleave', release);
            btn.addEventListener('touchstart', e => { e.preventDefault(); press(); }, { passive: false });
            btn.addEventListener('touchend', release);
        });

        // Управление клавишами
        const keyMap = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right', ' ': 'stop', h: 'home' };
        const keysPressed = {};
        window.addEventListener('keydown', e => { const dir = keyMap[e.key]; if (dir && !keysPressed[dir]) { sendPress(dir, 'press'); keysPressed[dir] = true; } });
        window.addEventListener('keyup', e => { const dir = keyMap[e.key]; if (dir && keysPressed[dir]) { sendPress(dir, 'release'); keysPressed[dir] = false; } });

        // Scale кнопки
        document.querySelectorAll('.scale-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                sendPress('SCALE', 'press', parseFloat(btn.dataset.scale));
            });
        });

        // Поля ввода
        ['xInput', 'yInput', 'speed', 'stepLength'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('change', e => {
                sendPress(id.toUpperCase(), 'press', parseFloat(e.target.value));
            });
        });

        // Кнопка Применить
        document.getElementById('zeroBtn').addEventListener('click', () => {
            sendPress('ZERO', 'press');
        });
    </script>
</body>

</html>