<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Управление ЧПУ</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>

    <!-- === ВЕРХНИЙ ВЫБОР РЕЖИМА === -->
    <div class="mode-selector">
        <button class="mode-btn selected" data-mode="cnc">
            <img src="misc/cnc.png" alt="Движение"><span>Движение</span>
        </button>
        <button class="mode-btn" data-mode="arm">
            <img src="misc/roboarm.png" alt="Рука"><span>Рука</span>
        </button>
        <button class="mode-btn" data-mode="head">
            <img src="misc/doze.png" alt="Голова"><span>Голова</span>
        </button>
        <button class="mode-btn" data-mode="vortex">
            <img src="misc/vortex.png" alt="Нагрев"><span>Нагрев</span>
        </button>
        <button class="mode-btn" data-mode="synth">
            <img src="misc/synthesis.png" alt="Синтез"><span>Синтез</span>
        </button>
    </div>

    <div class="main-content">

        <!-- === CNC === -->
        <div id="cnc-ui">
            <div class="grid-container">
                <div class="col">
                    <h3>Координаты</h3>
                    <div class="step-control">
                        Шаг Δ: <input type="number" id="cncStep" value="5" step="0.1" min="0.1">
                    </div>

                    <div class="control-row">
                        <label>X</label>
                        <button onclick="adjustCNC('x', -cncStep)">-</button>
                        <input type="number" id="xInput" value="0" step="0.01">
                        <button onclick="adjustCNC('x', cncStep)">+</button>
                        <input type="range" class="slider" id="xSlider" min="0" max="90" step="0.01" value="0">
                    </div>
                    <div class="control-row">
                        <label>Y</label>
                        <button onclick="adjustCNC('y', -cncStep)">-</button>
                        <input type="number" id="yInput" value="0" step="0.01">
                        <button onclick="adjustCNC('y', cncStep)">+</button>
                        <input type="range" class="slider" id="ySlider" min="0" max="60" step="0.01" value="0">
                    </div>

                    <div class="move-row">
                        <button class="move-btn" id="cncMoveBtn">MOVE</button>
                        <button class="home-btn" id="cncHomeBtn">HOME</button>
                        <button class="toggle-btn" id="cncPowerBtn">OFF</button>
                    </div>
                </div>

                <div class="col">
                    <h3>Управление</h3>
                    <div class="pad">
                        <div></div>
                        <button class="dir up" data-dir="up"><img src="misc/up.svg" alt="up"></button>
                        <div></div>
                        <button class="dir left" data-dir="left"><img src="misc/left.svg" alt="left"></button>
                        <div></div>
                        <button class="dir right" data-dir="right"><img src="misc/right.svg" alt="right"></button>
                        <div></div>
                        <button class="dir down" data-dir="down"><img src="misc/down.svg" alt="down"></button>
                        <div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VORTEX === -->
        <div id="vortex-ui" class="hidden">
            <div class="vortex-grid">
                <div class="vortex-col">
                    <div class="vortex-header">
                        <h3>Нагрев</h3>
                        <button class="toggle-btn" id="heaterPowerBtn">OFF</button>
                    </div>
                    <div class="control-group">
                        <label>Текущая: <span id="currentTemp" class="current-temp">--.-</span> °C</label>
                    </div>
                    <div class="control-row">
                        <label>Уставка:</label>
                        <input type="number" id="tempInput" value="25" step="0.5" min="0" max="300">
                        <input type="range" class="slider" id="tempSlider" min="0" max="300" value="25" step="0.5">
                    </div>
                    <button class="pid-btn" id="pidToggle">PID: AUTO</button>
                </div>

                <div class="vortex-col">
                    <div class="vortex-header">
                        <h3>Мешалка</h3>
                        <button class="toggle-btn" id="mixPowerBtn">OFF</button>
                    </div>
                    <div class="control-row">
                        <label>Скорость:</label>
                        <input type="number" id="mixInput" value="0" step="1" min="0" max="100">
                        <input type="range" class="slider" id="mixSlider" min="0" max="100" value="0" step="1">
                    </div>
                    <div class="control-row">
                        <label>Таймер:</label>
                        <input type="number" id="timerInput" value="10" step="1" min="1">
                        <div class="timer-row">
                            <button data-timer="5">5 с</button>
                            <button data-timer="10">10 с</button>
                            <button data-timer="30">30 с</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === ARM === -->
        <div id="arm-ui" class="hidden">
            <div class="arm-grid">
                <!-- <div class="arm-grid" style="grid-template-columns: 1fr 320px 1fr; gap:28px;"> -->
                <div class="arm-col">
                    <h3>Прямая кинематика</h3>
                    <div class="step-control">
                        Шаг Δ: <input type="number" id="deltaInput" value="5" step="1" min="1">
                    </div>

                    <div class="joint-row">
                        <label>θ1</label>
                        <button onclick="adjustJoint('j1', -delta)">-</button>
                        <input type="number" id="j1Value" value="0" step="1">
                        <button onclick="adjustJoint('j1', delta)">+</button>
                        <input type="range" class="slider" id="j1Slider" min="-180" max="180" value="0">
                    </div>
                    <div class="joint-row">
                        <label>θ2</label>
                        <button onclick="adjustJoint('j2', -delta)">-</button>
                        <input type="number" id="j2Value" value="0" step="1">
                        <button onclick="adjustJoint('j2', delta)">+</button>
                        <input type="range" class="slider" id="j2Slider" min="-180" max="180" value="0">
                    </div>
                    <div class="joint-row">
                        <label>φ</label>
                        <button onclick="adjustJoint('j3', -delta)">-</button>
                        <input type="number" id="j3Value" value="0" step="1">
                        <button onclick="adjustJoint('j3', delta)">+</button>
                        <input type="range" class="slider" id="j3Slider" min="-90" max="90" value="0">
                    </div>
                    <div class="joint-row">
                        <label>Z</label>
                        <input type="range" class="slider" id="zSlider" min="0" max="300" value="150">
                        <input type="number" id="zValue" value="150" step="1">
                    </div>
                </div>





                <div class="arm-col">
                    <h3>Управление</h3>
                    <div class="pad arm-pad-extended"
                        style="position:relative;display:grid;grid-template-columns:repeat(3,60px);grid-template-rows:60px 60px 60px;gap:12px;justify-content:center;align-content:center;">

                        <button class="dir grab" data-grip="-"><img src="misc/let.png"></button>
                        <button class="dir grab" data-grip="+"><img src="misc/grab.svg"></button>
                        <div></div>

                        <button class="dir left" data-arm-dir="x-"><img src="misc/left.svg"></button>
                        <button class="dir up" data-arm-dir="y+"><img src="misc/up.svg"></button>
                        <!-- <button class="dir z-down" data-z="-"><img src="misc/UP_Z.png"></button> -->
                        <button class="dir z-down" data-z="-">Z+</button>

                        <button class="dir right" data-arm-dir="x+"><img src="misc/right.svg"></button>
                        <button class="dir down" data-arm-dir="y-"><img src="misc/down.svg"></button>
                        <!-- <button class="dir z-up" data-z="+"><img src="misc/DOWN_Z.png"></button> -->
                        <button class="dir z-up" data-z="+">Z-</button>

                        <button id="emergencyStop" class="dir"
                            style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:64px;height:64px;padding:0;background:#ff5555;border:none;border-radius:8px;z-index:10;">
                            <img src="misc/stop.svg" style="width:36px;height:36px;filter:brightness(0)invert(1);">
                        </button>
                    </div>
                </div>











                <div class="arm-col">
                    <h3>Обратная кинематика</h3>
                    <div class="ik-row">
                        <label>X</label> <input type="number" id="xTarget" value="270" step="1">
                        <label>Y</label> <input type="number" id="yTarget" value="0" step="1">
                        <label>Z</label> <input type="number" id="zTarget" value="150" step="1">
                    </div>

                    <div class="move-row-arm">
                        <button class="move-btn" id="moveBtn">MOVE</button>
                        <button class="home-btn" id="armHomeBtn">HOME</button>
                        <button class="toggle-btn" id="armPowerBtn">OFF</button>
                    </div>

                    <div class="gripper-label">Gripper Force</div>
                    <div class="gripper-row">
                        <input type="range" class="gripper-slider" id="gripperSlider" min="0" max="100" value="50">
                        <span id="gripperValue" class="gripper-value">50%</span>
                    </div>

                    <div class="bottom-row">
                        <div>
                            <label>Speed</label>
                            <input type="number" id="armSpeed" value="50" step="1" min="1">
                        </div>
                        <div>
                            <label>Accel</label>
                            <input type="number" id="armAccel" value="100" step="1" min="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === ГОЛОВА (ДОЗАТОР) === -->
        <div id="head-ui" class="hidden">
            <div class="dose-grid">
                <div class="dose-col">
                    <h3>Дозатор</h3>
                    <div class="dose-delta">
                        <label>Δ мл:</label>
                        <input type="number" id="doseDelta" value="10" step="1" min="1">
                    </div>
                    <div class="dose-main">
                        <button class="minus" id="doseMinus">DOSE –</button>
                        <input type="number" id="doseVolume" value="100" step="1" min="0" placeholder="мкл">
                        <button class="plus" id="dosePlus">DOSE +</button>
                    </div>
                    <div class="dose-pair">
                        <button class="wash" id="doseWash">Промывка</button>
                        <button class="intake" id="doseIntake">Забор</button>
                        <button class="reset" id="doseReset">Сброс давления</button>
                    </div>
                </div>

                <div class="dose-col">
                    <h3>Перистальтика</h3>
                    <div class="pump-controls">
                        <button class="pump-toggle" id="pumpToggle">
                            <img src="misc/stop.svg" alt="PUMP"> OFF
                        </button>
                        <button class="reverse-btn" id="pumpReverse">
                            РЕВЕРС
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === СИНТЕЗ === -->
        <div id="synth-ui" class="hidden">
            <div
                style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);text-align:center;max-width:600px;width:100%;">
                <h2>Синтез</h2>
                <p>Программы, логи, параметры...</p>
            </div>
        </div>
    </div>

    <script>
        const L1 = 150, L2 = 120;
        let cncStep = 5, delta = 5;

        // === ПЕРЕКЛЮЧЕНИЕ РЕЖИМОВ ===
        const modeButtons = document.querySelectorAll('.mode-btn');
        const uiBlocks = {
            cnc: document.getElementById('cnc-ui'),
            arm: document.getElementById('arm-ui'),
            head: document.getElementById('head-ui'),
            vortex: document.getElementById('vortex-ui'),
            synth: document.getElementById('synth-ui')
        };

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modeButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                Object.values(uiBlocks).forEach(b => b.classList.add('hidden'));
                uiBlocks[btn.dataset.mode].classList.remove('hidden');
            });
        });

        // === CNC ===
        const xInput = document.getElementById('xInput');
        const xSlider = document.getElementById('xSlider');
        const yInput = document.getElementById('yInput');
        const ySlider = document.getElementById('ySlider');
        const cncStepInput = document.getElementById('cncStep');
        const cncMoveBtn = document.getElementById('cncMoveBtn');
        const cncHomeBtn = document.getElementById('cncHomeBtn');
        const cncPowerBtn = document.getElementById('cncPowerBtn');
        let cncPower = false;

        cncStepInput.addEventListener('change', () => {
            cncStep = Math.max(0.1, parseFloat(cncStepInput.value) || 5);
            cncStepInput.value = cncStep;
        });

        function syncSlider(input, slider) {
            slider.addEventListener('input', () => input.value = parseFloat(slider.value).toFixed(2));
            input.addEventListener('change', () => {
                let v = parseFloat(input.value);
                v = Math.max(0, Math.min(500, v));
                input.value = v.toFixed(2);
                slider.value = v;
            });
        }
        syncSlider(xInput, xSlider);
        syncSlider(yInput, ySlider);

        window.adjustCNC = function (axis, delta) {
            const input = axis === 'x' ? xInput : yInput;
            const slider = axis === 'x' ? xSlider : ySlider;
            let v = parseFloat(input.value) + delta;
            v = Math.max(0, Math.min(500, v));
            input.value = v.toFixed(2);
            slider.value = v;
        };

        cncMoveBtn.addEventListener('click', () => {
            if (cncPower) sendCNC('move', { x: parseFloat(xInput.value), y: parseFloat(yInput.value) });
        });

        cncHomeBtn.addEventListener('click', () => {
            xInput.value = '0.00'; xSlider.value = 0;
            yInput.value = '0.00'; ySlider.value = 0;
            sendCNC('home');
        });

        cncPowerBtn.addEventListener('click', () => {
            cncPower = !cncPower;
            cncPowerBtn.classList.toggle('active', cncPower);
            cncPowerBtn.textContent = cncPower ? 'ON' : 'OFF';
            sendCNC(cncPower ? 'power_on' : 'power_off');
        });

        function sendCNC(action, data = null) {
            fetch('/cnc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...data })
            }).catch(() => { });
        }

        // === ДЖОЙСТИК: движение на шаг при нажатии ===
        document.querySelectorAll('#cnc-ui button.dir').forEach(btn => {
            const dir = btn.dataset.dir;
            const axis = (dir === 'left' || dir === 'right') ? 'x' : 'y';
            const sign = (dir === 'right' || dir === 'up') ? 1 : -1;

            btn.addEventListener('click', () => {
                if (!cncPower) return;

                const input = axis === 'x' ? xInput : yInput;
                const slider = axis === 'x' ? xSlider : ySlider;
                let value = parseFloat(input.value);
                value = Math.max(0, Math.min(500, value + sign * cncStep));

                input.value = value.toFixed(2);
                slider.value = value;
            });
        });
        // === ARM ===
        const j1Slider = document.getElementById('j1Slider'), j1Value = document.getElementById('j1Value');
        const j2Slider = document.getElementById('j2Slider'), j2Value = document.getElementById('j2Value');
        const j3Slider = document.getElementById('j3Slider'), j3Value = document.getElementById('j3Value');
        const zSlider = document.getElementById('zSlider'), zValue = document.getElementById('zValue');
        const xTarget = document.getElementById('xTarget'), yTarget = document.getElementById('yTarget'), zTarget = document.getElementById('zTarget');
        const moveBtn = document.getElementById('moveBtn');
        const armHomeBtn = document.getElementById('armHomeBtn');
        const armPowerBtn = document.getElementById('armPowerBtn');
        const gripperSlider = document.getElementById('gripperSlider'), gripperValue = document.getElementById('gripperValue');
        const deltaInput = document.getElementById('deltaInput');
        const armSpeed = document.getElementById('armSpeed'), armAccel = document.getElementById('armAccel');
        let armPower = false;

        deltaInput.addEventListener('change', () => delta = Math.max(1, parseInt(deltaInput.value) || 5));

        function syncSliderValue(slider, input, updateXY = false, updateZ = false, updateGripper = false) {
            slider.addEventListener('input', () => {
                input.value = slider.value;
                if (updateXY) forwardKinematics();
                if (updateZ) zTarget.value = slider.value;
                if (updateGripper) {
                    const force = Math.round((parseInt(slider.value) + 90) / 1.8);
                    gripperSlider.value = force;
                    gripperValue.textContent = force + '%';
                }
            });
            input.addEventListener('change', () => {
                let v = parseInt(input.value);
                v = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), v));
                input.value = v; slider.value = v;
                if (updateXY) forwardKinematics();
                if (updateZ) zTarget.value = v;
                if (updateGripper) {
                    const force = Math.round((v + 90) / 1.8);
                    gripperSlider.value = force;
                    gripperValue.textContent = force + '%';
                }
            });
        }
        syncSliderValue(j1Slider, j1Value, true);
        syncSliderValue(j2Slider, j2Value, true);
        syncSliderValue(j3Slider, j3Value, false, false, true);
        syncSliderValue(zSlider, zValue, false, true);

        function forwardKinematics() {
            const t1 = parseFloat(j1Value.value) * Math.PI / 180;
            const t2 = parseFloat(j2Value.value) * Math.PI / 180;
            const x = Math.round(L1 * Math.cos(t1) + L2 * Math.cos(t1 + t2));
            const y = Math.round(L1 * Math.sin(t1) + L2 * Math.sin(t1 + t2));
            xTarget.value = x; yTarget.value = y;
            sendArm({ type: 'joints', j1: j1Value.value, j2: j2Value.value, j3: j3Value.value, z: zValue.value });
        }

        function inverseKinematics(x, y) {
            const d = (x * x + y * y - L1 * L1 - L2 * L2) / (2 * L1 * L2);
            if (Math.abs(d) > 1) return false;
            let theta2 = Math.acos(d);
            if (x < 0 && y < 0) theta2 = -theta2;
            let theta1 = Math.atan2(y, x) - Math.atan2(L2 * Math.sin(theta2), L1 + L2 * Math.cos(theta2));
            theta2 = -theta2 * 180 / Math.PI;
            theta1 = theta1 * 180 / Math.PI;

            if (x >= 0 && y >= 0) theta1 = 90 - theta1;
            else if (x < 0 && y > 0) theta1 = 90 - theta1;
            else if (x < 0 && y < 0) theta1 = 270 - theta1;
            else if (x > 0 && y < 0) theta1 = -90 - theta1;

            j1Value.value = Math.round(theta1); j1Slider.value = j1Value.value;
            j2Value.value = Math.round(theta2); j2Slider.value = j2Value.value;
            return true;
        }

        xTarget.addEventListener('change', () => yTarget.dispatchEvent(new Event('change')));
        yTarget.addEventListener('change', () => {
            const x = parseFloat(xTarget.value), y = parseFloat(yTarget.value);
            if (!isNaN(x) && !isNaN(y)) inverseKinematics(x, y);
        });
        zTarget.addEventListener('change', () => { zValue.value = zTarget.value; zSlider.value = zTarget.value; });

        gripperSlider.addEventListener('input', () => {
            gripperValue.textContent = gripperSlider.value + '%';
            const phi = Math.round(gripperSlider.value * 1.8 - 90);
            j3Value.value = phi; j3Slider.value = phi;
            if (armPower) {
                sendArm({ type: 'gripper', force: gripperSlider.value });
            }
        });

        moveBtn.addEventListener('click', () => {
            if (armPower) {
                sendArm({ type: 'move', x: parseFloat(xTarget.value), y: parseFloat(yTarget.value), z: parseFloat(zTarget.value), speed: parseFloat(armSpeed.value), accel: parseFloat(armAccel.value) });
            }
        });

        armHomeBtn.addEventListener('click', () => {
            j1Value.value = 0; j1Slider.value = 0;
            j2Value.value = 0; j2Slider.value = 0;
            j3Value.value = 0; j3Slider.value = 0;
            zValue.value = 150; zSlider.value = 150;
            xTarget.value = 270; yTarget.value = 0; zTarget.value = 150;
            gripperSlider.value = 50; gripperValue.textContent = '50%';
            forwardKinematics();
            sendArm({ type: 'home' });
        });

        armPowerBtn.addEventListener('click', () => {
            armPower = !armPower;
            armPowerBtn.classList.toggle('active', armPower);
            armPowerBtn.textContent = armPower ? 'ON' : 'OFF';
            sendArm({ type: 'power', state: armPower ? 'on' : 'off' });
        });

        window.adjustJoint = function (joint, d) {
            const input = document.getElementById(joint + 'Value');
            let v = parseInt(input.value) + d;
            const min = joint === 'j3' ? -90 : -180;
            const max = joint === 'j3' ? 90 : 180;
            v = Math.max(min, Math.min(max, v));
            input.value = v;
            document.getElementById(joint + 'Slider').value = v;
            if (joint === 'j3') {
                const force = Math.round((v + 90) / 1.8);
                gripperSlider.value = force;
                gripperValue.textContent = force + '%';
            }
            forwardKinematics();
        };

        function sendArm(data) {
            fetch('/arm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(() => { });
        }

        // === VORTEX ===
        const tempSlider = document.getElementById('tempSlider'), tempInput = document.getElementById('tempInput');
        const mixSlider = document.getElementById('mixSlider'), mixInput = document.getElementById('mixInput');
        const timerInput = document.getElementById('timerInput');
        const currentTempEl = document.getElementById('currentTemp'), pidToggle = document.getElementById('pidToggle');
        const heaterPowerBtn = document.getElementById('heaterPowerBtn');
        const mixPowerBtn = document.getElementById('mixPowerBtn');
        let heaterOn = false, mixOn = false, pidAuto = true;

        tempSlider.addEventListener('input', () => { tempInput.value = tempSlider.value; if (heaterOn) sendVortex('heater_set', tempSlider.value); });
        tempInput.addEventListener('change', () => { let v = Math.max(0, Math.min(300, parseFloat(tempInput.value) || 0)); tempInput.value = v; tempSlider.value = v; if (heaterOn) sendVortex('heater_set', v); });
        mixSlider.addEventListener('input', () => { mixInput.value = mixSlider.value; if (mixOn) sendVortex('mix_speed', mixSlider.value); });
        mixInput.addEventListener('change', () => { let v = Math.max(0, Math.min(100, parseInt(mixInput.value) || 0)); mixInput.value = v; mixSlider.value = v; if (mixOn) sendVortex('mix_speed', v); });
        document.querySelectorAll('[data-timer]').forEach(b => b.addEventListener('click', () => { timerInput.value = b.dataset.timer; sendVortex('timer', b.dataset.timer); }));
        timerInput.addEventListener('change', () => { if (timerInput.value > 0) sendVortex('timer', timerInput.value); });

        heaterPowerBtn.addEventListener('click', () => {
            heaterOn = !heaterOn;
            heaterPowerBtn.classList.toggle('active', heaterOn);
            heaterPowerBtn.textContent = heaterOn ? 'ON' : 'OFF';
            sendVortex(heaterOn ? 'heater_on' : 'heater_off', heaterOn ? tempInput.value : null);
        });

        mixPowerBtn.addEventListener('click', () => {
            mixOn = !mixOn;
            mixPowerBtn.classList.toggle('active', mixOn);
            mixPowerBtn.textContent = mixOn ? 'ON' : 'OFF';
            sendVortex(mixOn ? 'mix_on' : 'mix_off', mixOn ? mixInput.value : null);
        });

        pidToggle.addEventListener('click', () => { pidAuto = !pidAuto; pidToggle.textContent = `PID: ${pidAuto ? 'AUTO' : 'MANUAL'}`; sendVortex('pid_toggle', pidAuto ? 'auto' : 'manual'); });
        function sendVortex(a, v = null) { fetch('/vortex', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: a, value: v }) }).catch(() => { }); }
        function updateTemp() { fetch('/temp').then(r => r.json()).then(d => { if (d.temp !== undefined) currentTempEl.textContent = d.temp.toFixed(1); }).catch(() => { }); }
        setInterval(updateTemp, 1000); updateTemp();

        // === ДОЗАТОР ===
        const dosePlus = document.getElementById('dosePlus');
        const doseMinus = document.getElementById('doseMinus');
        const doseVolume = document.getElementById('doseVolume');
        const doseDelta = document.getElementById('doseDelta');
        const doseWash = document.getElementById('doseWash');
        const doseIntake = document.getElementById('doseIntake');
        const doseReset = document.getElementById('doseReset');
        const pumpToggle = document.getElementById('pumpToggle');
        const pumpReverse = document.getElementById('pumpReverse');
        let pumpOn = false, pumpReverseOn = false;

        dosePlus.addEventListener('click', () => {
            const delta = parseInt(doseDelta.value) || 1;
            let vol = parseInt(doseVolume.value) || 0;
            vol += delta;
            doseVolume.value = vol;
            sendDose('dose_plus', vol);
        });
        doseMinus.addEventListener('click', () => {
            const delta = parseInt(doseDelta.value) || 1;
            let vol = parseInt(doseVolume.value) || 0;
            vol = Math.max(0, vol - delta);
            doseVolume.value = vol;
            sendDose('dose_minus', vol);
        });

        doseWash.addEventListener('click', () => sendDose('wash'));
        doseIntake.addEventListener('click', () => sendDose('intake'));
        doseReset.addEventListener('click', () => sendDose('reset_pressure'));

        pumpToggle.addEventListener('click', () => {
            pumpOn = !pumpOn;
            pumpToggle.classList.toggle('active', pumpOn);
            pumpToggle.innerHTML = pumpOn
                ? `<img src="misc/vortex.png" alt="ON"> ON`
                : `<img src="misc/stop.svg" alt="OFF"> OFF`;
            sendDose('pump', pumpOn ? 'on' : 'off');
        });

        pumpReverse.addEventListener('click', () => {
            pumpReverseOn = !pumpReverseOn;
            pumpReverse.classList.toggle('active', pumpReverseOn);
            sendDose('reverse', pumpReverseOn);
        });

        function sendDose(action, value = null) {
            fetch('/dose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, value })
            }).catch(() => { });
        }

        // Инициализация
        forwardKinematics();
        gripperSlider.value = 50;
        gripperValue.textContent = '50%';
        j3Value.value = 0;
        j3Slider.value = 0;
















        // === НОВАЯ ЛОГИКА ДЖОЙСТИКА РОБОРУКИ (XY + Z + Grab + ESTOP) ===
        document.querySelectorAll('#arm-ui button.dir[data-arm-dir]') // XY кнопки
            .forEach(btn => {
                const dir = btn.dataset.armDir;
                let interval = null;
                const step = () => {
                    if (!armPower) return;
                    let newX = parseFloat(xTarget.value);
                    let newY = parseFloat(yTarget.value);
                    if (dir === 'x+') newX += delta;
                    if (dir === 'x-') newX -= delta;
                    if (dir === 'y+') newY += delta;
                    if (dir === 'y-') newY -= delta;
                    newX = Math.max(50, Math.min(400, newX));
                    newY = Math.max(-250, Math.min(250, newY));
                    xTarget.value = newX; yTarget.value = newY;
                    inverseKinematics(newX, newY);
                };
                btn.addEventListener('mousedown', () => { step(); interval = setInterval(step, 150); });
                btn.addEventListener('touchstart', e => { e.preventDefault(); step(); interval = setInterval(step, 150); });
                const stop = () => clearInterval(interval);
                btn.addEventListener('mouseup', stop); btn.addEventListener('mouseleave', stop);
                btn.addEventListener('touchend', stop); btn.addEventListener('touchcancel', stop);
            });

        document.querySelectorAll('#arm-ui button.dir[data-z]') // Z кнопки
            .forEach(btn => {
                const sign = btn.dataset.z === '+' ? delta : -delta;
                let interval = null;
                const step = () => {
                    if (!armPower) return;
                    let newZ = parseInt(zTarget.value) + sign;
                    newZ = Math.max(0, Math.min(300, newZ));
                    zTarget.value = newZ; zValue.value = newZ; zSlider.value = newZ;
                };
                btn.addEventListener('mousedown', () => { step(); interval = setInterval(step, 150); });
                btn.addEventListener('touchstart', e => { e.preventDefault(); step(); interval = setInterval(step, 150); });
                const stop = () => clearInterval(interval);
                btn.addEventListener('mouseup', stop); btn.addEventListener('mouseleave', stop);
                btn.addEventListener('touchend', stop); btn.addEventListener('touchcancel', stop);
            });

        document.querySelectorAll('#arm-ui button.dir[data-grip]') // Grab кнопки
            .forEach(btn => {
                const sign = btn.dataset.grip === '+' ? 5 : -5;
                let interval = null;
                const step = () => {
                    if (!armPower) return;
                    let force = parseInt(gripperSlider.value) + sign;
                    force = Math.max(0, Math.min(100, force));
                    gripperSlider.value = force; gripperValue.textContent = force + '%';
                    const phi = Math.round(force * 1.8 - 90);
                    j3Value.value = phi; j3Slider.value = phi;
                    sendArm({ type: 'gripper', force });
                };
                btn.addEventListener('mousedown', () => { step(); interval = setInterval(step, 100); });
                btn.addEventListener('touchstart', e => { e.preventDefault(); step(); interval = setInterval(step, 100); });
                const stop = () => clearInterval(interval);
                btn.addEventListener('mouseup', stop); btn.addEventListener('mouseleave', stop);
                btn.addEventListener('touchend', stop); btn.addEventListener('touchcancel', stop);
            });

        document.getElementById('emergencyStop').addEventListener('click', () => {
            if (armPower) sendArm({ type: 'estop' });
        });

        // Добавь это в конец скрипта
        document.getElementById('emergencyStop').addEventListener('click', function () {
            if (!armPower) return;

            this.style.background = '#4fc3f7';
            setTimeout(() => this.style.background = '#ff5555', 200);

            sendArm({ type: 'estop' });
        });
    </script>
</body>

</html>