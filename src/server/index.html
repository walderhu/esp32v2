<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Управление ЧПУ</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            box-sizing: border-box;
            background: #f8f9fa;
            font-family: sans-serif;
        }

        /* === ВЕРХНЯЯ ПАНЕЛЬ РЕЖИМОВ === */
        .mode-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px 60px 30px 60px;
            background: #fff;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }

        .mode-btn {
            background: #fff;
            border: 2px solid #ccc;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            width: 100px;
        }

        .mode-btn img {
            width: 64px;
            height: 64px;
            object-fit: contain;
        }

        .mode-btn span {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .mode-btn:hover {
            border-color: #007bff;
            box-shadow: 0 6px 14px rgba(0, 123, 255, 0.2);
        }

        .mode-btn.selected {
            border-color: #007bff;
            background: #e9f2ff;
            box-shadow: 0 6px 14px rgba(0, 123, 255, 0.3);
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        /* === VORTEX === */
        .vortex-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            max-width: 1000px;
            width: 100%;
        }

        .vortex-col {
            background: #fff;
            border: 1px solid #ddd;
            _BORDER: 1px solid #ddd;
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .vortex-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .vortex-header h3 {
            margin: 0;
            font-size: 19px;
            font-weight: 600;
        }

        .toggle-icon-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #f8d7da;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-icon-btn.active {
            background: #d4edda;
        }

        .toggle-icon-btn img {
            width: 24px;
            height: 24px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .control-row label {
            min-width: 80px;
            font-weight: 600;
            font-size: 14px;
        }

        .control-row input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }

        .current-temp {
            font-size: 36px;
            color: #d63384;
            font-weight: bold;
            margin: 4px 0;
        }

        .timer-row {
            flex: 1;
            display: flex;
            gap: 6px;
            margin-left: 10px;
        }

        .timer-row button {
            flex: 1;
            padding: 6px 4px;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
        }

        .timer-row button:active {
            background: #007bff;
            color: white;
        }

        .pid-btn {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            background: #e9ecef;
            border: 1px solid #aaa;
            border-radius: 8px;
            cursor: pointer;
        }

        /* === ARM === */
        .arm-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
            max-width: 1000px;
            width: 100%;
        }

        .arm-col {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .arm-col h3 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 18px;
            text-align: center;
            font-weight: 600;
        }

        .step-control {
            text-align: center;
            margin-bottom: 14px;
            font-size: 14px;
        }

        .step-control input {
            width: 50px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .joint-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .joint-row label {
            min-width: 40px;
            font-weight: 600;
            font-size: 14px;
        }

        .joint-row button {
            width: 32px;
            height: 32px;
            font-size: 16px;
            font-weight: bold;
            background: #e9ecef;
            border: 1px solid #aaa;
            border-radius: 6px;
            cursor: pointer;
        }

        .joint-row input[type="number"] {
            width: 60px;
            text-align: center;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .joint-row .slider {
            flex: 1;
        }

        .ik-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .ik-row label {
            min-width: 30px;
            font-size: 14px;
            font-weight: 600;
        }

        .ik-row input {
            width: 70px;
            padding: 6px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .move-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 16px 0 12px 0;
            font-size: 16px;
        }

        .gripper-label {
            font-size: 13px;
            color: #555;
            text-align: center;
            margin: 8px 0 4px 0;
            font-weight: 600;
        }

        .gripper-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .gripper-toggle {
            width: 44px;
            height: 44px;
            padding: 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #f8d7da;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gripper-toggle.active {
            background: #d4edda;
        }

        .gripper-toggle img {
            width: 24px;
            height: 24px;
        }

        .gripper-slider {
            flex: 1;
        }

        .gripper-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }

        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .bottom-row div {
            display: flex;
            flex-direction: column;
        }

        .bottom-row label {
            font-size: 13px;
            margin-bottom: 4px;
            color: #555;
        }

        .bottom-row input {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
        }

        /* === ДОЗАТОР === */
        .dose-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
            max-width: 1100px;
            width: 100%;
        }

        .dose-col {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .dose-col h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            text-align: center;
            font-weight: 600;
        }

        .dose-main {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .dose-main input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
        }

        .dose-main button {
            width: 80px;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .dose-main .plus {
            background: #e9ecef;
            color: #212529;
        }

        .dose-main .minus {
            background: #f8d7da;
            color: #721c24;
        }

        .dose-delta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .dose-delta label {
            min-width: 50px;
            font-weight: 600;
        }

        .dose-pair {
            display: flex;
            gap: 10px;
        }

        .dose-pair button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            background: #e9ecef;
            color: #212529;
        }

        .dose-pair .wash {
            background: #fff3cd;
            color: #856404;
        }

        .dose-pair .intake {
            background: #d1ecf1;
            color: #0c5460;
        }

        .dose-pair .reset {
            background: #e2e3e5;
            color: #495057;
        }

        .pump-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pump-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #e9ecef;
            border: 1px solid #aaa;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }

        .pump-toggle.active {
            background: #d4edda;
            border-color: #28a745;
        }

        .pump-toggle img {
            width: 20px;
            height: 20px;
        }

        .reverse-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: #dc3545;
            color: white;
        }

        .reverse-btn.active {
            background: #28a745;
        }

        /* === CNC === */
        .container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 50px;
            max-width: 1000px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                gap: 24px;
            }
        }

        .pad {
            width: 300px;
            height: 300px;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
            position: relative;
            box-sizing: border-box;
        }

        button.dir {
            border: none;
            border-radius: 10px;
            background: #f1f1f1;
            cursor: pointer;
            transition: background .1s, transform .1s;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            aspect-ratio: 1/1;
        }

        button.dir img {
            width: 32px;
            height: 32px;
        }

        button.dir:active,
        button.dir.pressed {
            background: #cce5ff;
            transform: scale(0.95);
        }

        .home {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e6ffe6;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 420px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .columns-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .coord-input,
        .speed-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .coord-input label,
        .speed-input label {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            padding-left: 10px;
        }

        .axis {
            min-width: 70px;
            flex-shrink: 0;
        }

        .meta {
            font-size: 11px;
            color: #999;
            background: #f5f5f5;
            padding: 3px 5px;
            border-radius: 3px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .coord-input input,
        .speed-input input {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 6px;
            font-size: 18px;
            text-align: center;
            background: #fefefe;
            width: 80px;
        }

        .unit {
            font-size: 13px;
            color: #888;
            text-align: center;
            width: 80px;
        }

        .zero-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
            transition: background .1s;
        }

        .zero-btn:active {
            background: #218838;
        }
    </style>
</head>

<body>

    <!-- === ВЕРХНИЙ ВЫБОР РЕЖИМА === -->
    <div class="mode-selector">
        <button class="mode-btn selected" data-mode="cnc">
            <img src="misc/cnc.png" alt="Движение"><span>Движение</span>
        </button>
        <button class="mode-btn" data-mode="arm">
            <img src="misc/roboarm.png" alt="Рука"><span>Рука</span>
        </button>
        <button class="mode-btn" data-mode="head">
            <img src="misc/doze.png" alt="Голова"><span>Голова</span>
        </button>
        <button class="mode-btn" data-mode="vortex">
            <img src="misc/vortex.png" alt="Нагрев"><span>Нагрев</span>
        </button>
        <button class="mode-btn" data-mode="synth">
            <img src="misc/synthesis.png" alt="Синтез"><span>Синтез</span>
        </button>
    </div>

    <div class="main-content">

        <!-- === CNC === -->
        <div id="cnc-ui">
            <div class="container">
                <div class="controls">
                    <div class="columns-row">
                        <div class="column">
                            <div class="coord-input">
                                <label><span class="axis">X:</span> <span class="meta">[0.00]</span></label>
                                <input type="number" id="xInput" value="52.91" step="0.01">
                                <span class="unit">мм</span>
                            </div>
                            <div class="speed-input">
                                <label><span class="axis">Скорость</span></label>
                                <input type="number" id="speed" value="10" step="1">
                                <span class="unit">мм/с</span>
                            </div>
                        </div>
                        <div class="column">
                            <div class="coord-input">
                                <label><span class="axis">Y:</span> <span class="meta">[0.00]</span></label>
                                <input type="number" id="yInput" value="62.03" step="0.01">
                                <span class="unit">мм</span>
                            </div>
                            <div class="speed-input">
                                <label><span class="axis">Длина шага</span></label>
                                <input type="number" id="stepLength" value="5" step="0.1">
                                <span class="unit">мм</span>
                            </div>
                        </div>
                    </div>
                    <button id="zeroBtn" class="zero-btn">Применить</button>
                </div>
                <div class="pad">
                    <button class="dir home" data-dir="home"><img src="misc/home.svg" alt="home"></button>
                    <button class="dir stop" data-dir="stop"><img src="misc/stop.svg" alt="Stop" width="32"
                            height="32"></button>
                    <button class="dir up" data-dir="up"><img src="misc/up.svg" alt="up" width="32"
                            height="32"></button>
                    <button class="dir down" data-dir="down"><img src="misc/down.svg" alt="down" width="32"
                            height="32"></button>
                    <button class="dir left" data-dir="left"><img src="misc/left.svg" alt="left" width="32"
                            height="32"></button>
                    <button class="dir right" data-dir="right"><img src="misc/right.svg" alt="right" width="32"
                            height="32"></button>
                </div>
            </div>
        </div>

        <!-- === VORTEX === -->
        <div id="vortex-ui" class="hidden">
            <div class="vortex-grid">
                <div class="vortex-col">
                    <div class="vortex-header">
                        <h3>Нагрев</h3>
                        <button id="heaterToggle" class="toggle-icon-btn">
                            <img src="misc/stop.svg" alt="Выкл">
                        </button>
                    </div>
                    <div class="control-group">
                        <label>Текущая: <span id="currentTemp" class="current-temp">--.-</span> °C</label>
                    </div>
                    <div class="control-row">
                        <label>Уставка:</label>
                        <input type="number" id="tempInput" value="25" step="0.5" min="0" max="300">
                        <input type="range" class="slider" id="tempSlider" min="0" max="300" value="25" step="0.5">
                    </div>
                    <button class="pid-btn" id="pidToggle">PID: AUTO</button>
                </div>

                <div class="vortex-col">
                    <div class="vortex-header">
                        <h3>Мешалка</h3>
                        <button id="mixToggle" class="toggle-icon-btn">
                            <img src="misc/stop.svg" alt="Выкл">
                        </button>
                    </div>
                    <div class="control-row">
                        <label>Скорость:</label>
                        <input type="number" id="mixInput" value="0" step="1" min="0" max="100">
                        <input type="range" class="slider" id="mixSlider" min="0" max="100" value="0" step="1">
                    </div>
                    <div class="control-row">
                        <label>Таймер:</label>
                        <input type="number" id="timerInput" value="10" step="1" min="1">
                        <div class="timer-row">
                            <button data-timer="5">5 с</button>
                            <button data-timer="10">10 с</button>
                            <button data-timer="30">30 с</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === ARM === -->
        <div id="arm-ui" class="hidden">
            <div class="arm-grid">
                <div class="arm-col">
                    <h3>Прямая кинематика</h3>
                    <div class="step-control">
                        Шаг Δ: <input type="number" id="deltaInput" value="5" step="1" min="1">
                    </div>

                    <div class="joint-row">
                        <label>θ1</label>
                        <button onclick="adjustJoint('j1', -delta)">−</button>
                        <input type="number" id="j1Value" value="0" step="1">
                        <button onclick="adjustJoint('j1', delta)">+</button>
                        <input type="range" class="slider" id="j1Slider" min="-180" max="180" value="0">
                    </div>
                    <div class="joint-row">
                        <label>θ2</label>
                        <button onclick="adjustJoint('j2', -delta)">−</button>
                        <input type="number" id="j2Value" value="0" step="1">
                        <button onclick="adjustJoint('j2', delta)">+</button>
                        <input type="range" class="slider" id="j2Slider" min="-180" max="180" value="0">
                    </div>
                    <div class="joint-row">
                        <label>φ</label>
                        <button onclick="adjustJoint('j3', -delta)">−</button>
                        <input type="number" id="j3Value" value="0" step="1">
                        <button onclick="adjustJoint('j3', delta)">+</button>
                        <input type="range" class="slider" id="j3Slider" min="-90" max="90" value="0">
                    </div>
                    <div class="joint-row">
                        <label>Z</label>
                        <input type="range" class="slider" id="zSlider" min="0" max="300" value="150">
                        <input type="number" id="zValue" value="150" step="1">
                    </div>
                </div>

                <div class="arm-col">
                    <h3>Обратная кинематика</h3>
                    <div class="ik-row">
                        <label>X</label> <input type="number" id="xTarget" value="270" step="1">
                        <label>Y</label> <input type="number" id="yTarget" value="0" step="1">
                        <label>Z</label> <input type="number" id="zTarget" value="150" step="1">
                    </div>
                    <button class="move-btn" id="moveBtn">MOVE</button>

                    <div class="gripper-label">Хваталка</div>
                    <div class="gripper-row">
                        <button id="gripperToggle" class="gripper-toggle">
                            <img src="misc/stop.svg" alt="Выкл">
                        </button>
                        <input type="range" class="gripper-slider" id="gripperSlider" min="0" max="100" value="50">
                        <span id="gripperValue" class="gripper-value">50%</span>
                    </div>

                    <div class="bottom-row">
                        <div>
                            <label>Speed</label>
                            <input type="number" id="armSpeed" value="50" step="1" min="1">
                        </div>
                        <div>
                            <label>Accel</label>
                            <input type="number" id="armAccel" value="100" step="1" min="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === ГОЛОВА (ДОЗАТОР) === -->
        <div id="head-ui" class="hidden">
            <div class="dose-grid">
                <div class="dose-col">
                    <h3>Дозатор</h3>
                    <div class="dose-delta">
                        <label>Δ мл:</label>
                        <input type="number" id="doseDelta" value="10" step="1" min="1" style="width:60px;">
                    </div>
                    <div class="dose-main">
                        <button class="minus" id="doseMinus">DOSE –</button>
                        <input type="number" id="doseVolume" value="100" step="1" min="0" placeholder="мкл">
                        <button class="plus" id="dosePlus">DOSE +</button>
                    </div>
                    <div class="dose-pair">
                        <button class="wash" id="doseWash">Промывка</button>
                        <button class="intake" id="doseIntake">Забор</button>
                        <button class="reset" id="doseReset">Сброс давления</button>
                    </div>
                </div>

                <div class="dose-col">
                    <h3>Перистальтика</h3>
                    <div class="pump-controls">
                        <button class="pump-toggle" id="pumpToggle">
                            <img src="misc/stop.svg" alt="PUMP"> PUMP OFF
                        </button>
                        <button class="reverse-btn" id="pumpReverse">
                            РЕВЕРС
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === СИНТЕЗ === -->
        <div id="synth-ui" class="hidden">
            <div
                style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);text-align:center;max-width:600px;width:100%;">
                <h2>Синтез</h2>
                <p>Программы, логи, параметры...</p>
            </div>
        </div>
    </div>

    <script>
        const L1 = 150, L2 = 120;
        let delta = 5;

        // === ПЕРЕКЛЮЧЕНИЕ РЕЖИМОВ ===
        const modeButtons = document.querySelectorAll('.mode-btn');
        const uiBlocks = {
            cnc: document.getElementById('cnc-ui'),
            arm: document.getElementById('arm-ui'),
            head: document.getElementById('head-ui'),
            vortex: document.getElementById('vortex-ui'),
            synth: document.getElementById('synth-ui')
        };
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modeButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                Object.values(uiBlocks).forEach(b => b.classList.add('hidden'));
                uiBlocks[btn.dataset.mode].classList.remove('hidden');
            });
        });

        // === CNC ===
        const sendPress = (dir, action = "press", value = null) => {
            fetch('/press', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dir, action, value }) }).catch(() => { });
            const btn = document.querySelector(`button.dir[data-dir="${dir}"]`);
            if (btn) btn.classList.toggle('pressed', action === 'press');
        };
        document.querySelectorAll('button.dir').forEach(btn => {
            const dir = btn.dataset.dir;
            let pressed = false;
            const press = () => { if (!pressed) { sendPress(dir, 'press'); pressed = true; } };
            const release = () => { if (pressed) { sendPress(dir, 'release'); pressed = false; } };
            btn.addEventListener('mousedown', press);
            btn.addEventListener('mouseup', release);
            btn.addEventListener('mouseleave', release);
            btn.addEventListener('touchstart', e => { e.preventDefault(); press(); }, { passive: false });
            btn.addEventListener('touchend', release);
        });
        const keyMap = { ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right', ' ': 'stop', 'h': 'home' };
        const keys = {};
        window.addEventListener('keydown', e => { const d = keyMap[e.key]; if (d && !keys[d]) { sendPress(d, 'press'); keys[d] = true; } });
        window.addEventListener('keyup', e => { const d = keyMap[e.key]; if (d && keys[d]) { sendPress(d, 'release'); keys[d] = false; } });
        ['xInput', 'yInput', 'speed', 'stepLength'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', e => sendPress(id.toUpperCase(), 'press', parseFloat(e.target.value))); });
        document.getElementById('zeroBtn')?.addEventListener('click', () => sendPress('ZERO', 'press'));
        function updateCoords() { fetch('/coords').then(r => r.json()).then(d => { const xMeta = document.querySelector('#xInput')?.closest('.coord-input')?.querySelector('.meta'); const yMeta = document.querySelector('#yInput')?.closest('.coord-input')?.querySelector('.meta'); if (xMeta) xMeta.textContent = `[${d.x?.toFixed(2)}]`; if (yMeta) yMeta.textContent = `[${d.y?.toFixed(2)}]`; }).catch(() => { }); }
        setInterval(updateCoords, 200);

        // === VORTEX ===
        const tempSlider = document.getElementById('tempSlider'), tempInput = document.getElementById('tempInput');
        const mixSlider = document.getElementById('mixSlider'), mixInput = document.getElementById('mixInput');
        const timerInput = document.getElementById('timerInput');
        const heaterToggle = document.getElementById('heaterToggle'), mixToggle = document.getElementById('mixToggle');
        const currentTempEl = document.getElementById('currentTemp'), pidToggle = document.getElementById('pidToggle');
        let heaterOn = false, mixOn = false, pidAuto = true;

        tempSlider.addEventListener('input', () => { tempInput.value = tempSlider.value; if (heaterOn) sendVortex('heater_set', tempSlider.value); });
        tempInput.addEventListener('change', () => { let v = Math.max(0, Math.min(300, parseFloat(tempInput.value) || 0)); tempInput.value = v; tempSlider.value = v; if (heaterOn) sendVortex('heater_set', v); });
        mixSlider.addEventListener('input', () => { mixInput.value = mixSlider.value; if (mixOn) sendVortex('mix_speed', mixSlider.value); });
        mixInput.addEventListener('change', () => { let v = Math.max(0, Math.min(100, parseInt(mixInput.value) || 0)); mixInput.value = v; mixSlider.value = v; if (mixOn) sendVortex('mix_speed', v); });
        document.querySelectorAll('[data-timer]').forEach(b => b.addEventListener('click', () => { timerInput.value = b.dataset.timer; sendVortex('timer', b.dataset.timer); }));
        timerInput.addEventListener('change', () => { if (timerInput.value > 0) sendVortex('timer', timerInput.value); });

        heaterToggle.addEventListener('click', () => {
            heaterOn = !heaterOn;
            heaterToggle.classList.toggle('active', heaterOn);
            heaterToggle.querySelector('img').src = heaterOn ? 'misc/vortex.png' : 'misc/stop.svg';
            sendVortex(heaterOn ? 'heater_on' : 'heater_off', heaterOn ? tempInput.value : null);
        });
        mixToggle.addEventListener('click', () => {
            mixOn = !mixOn;
            mixToggle.classList.toggle('active', mixOn);
            mixToggle.querySelector('img').src = mixOn ? 'misc/vortex.png' : 'misc/stop.svg';
            sendVortex(mixOn ? 'mix_on' : 'mix_off', mixOn ? mixInput.value : null);
        });
        pidToggle.addEventListener('click', () => { pidAuto = !pidAuto; pidToggle.textContent = `PID: ${pidAuto ? 'AUTO' : 'MANUAL'}`; sendVortex('pid_toggle', pidAuto ? 'auto' : 'manual'); });
        function sendVortex(a, v = null) { fetch('/vortex', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: a, value: v }) }).catch(() => { }); }
        function updateTemp() { fetch('/temp').then(r => r.json()).then(d => { if (d.temp !== undefined) currentTempEl.textContent = d.temp.toFixed(1); }).catch(() => { }); }
        setInterval(updateTemp, 1000); updateTemp();

        // === ARM ===
        const j1Slider = document.getElementById('j1Slider'), j1Value = document.getElementById('j1Value');
        const j2Slider = document.getElementById('j2Slider'), j2Value = document.getElementById('j2Value');
        const j3Slider = document.getElementById('j3Slider'), j3Value = document.getElementById('j3Value');
        const zSlider = document.getElementById('zSlider'), zValue = document.getElementById('zValue');
        const xTarget = document.getElementById('xTarget'), yTarget = document.getElementById('yTarget'), zTarget = document.getElementById('zTarget');
        const moveBtn = document.getElementById('moveBtn');
        const gripperToggle = document.getElementById('gripperToggle'), gripperSlider = document.getElementById('gripperSlider'), gripperValue = document.getElementById('gripperValue');
        const deltaInput = document.getElementById('deltaInput');
        const armSpeed = document.getElementById('armSpeed'), armAccel = document.getElementById('armAccel');

        deltaInput.addEventListener('change', () => delta = Math.max(1, parseInt(deltaInput.value) || 5));

        function syncSliderValue(slider, input, updateXY = false, updateZ = false, updateGripper = false) {
            slider.addEventListener('input', () => {
                input.value = slider.value;
                if (updateXY) forwardKinematics();
                if (updateZ) zTarget.value = slider.value;
                if (updateGripper) {
                    const force = Math.round((parseInt(slider.value) + 90) / 1.8);
                    gripperSlider.value = force;
                    gripperValue.textContent = force + '%';
                }
            });
            input.addEventListener('change', () => {
                let v = parseInt(input.value);
                v = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), v));
                input.value = v; slider.value = v;
                if (updateXY) forwardKinematics();
                if (updateZ) zTarget.value = v;
                if (updateGripper) {
                    const force = Math.round((v + 90) / 1.8);
                    gripperSlider.value = force;
                    gripperValue.textContent = force + '%';
                }
            });
        }
        syncSliderValue(j1Slider, j1Value, true);
        syncSliderValue(j2Slider, j2Value, true);
        syncSliderValue(j3Slider, j3Value, false, false, true);
        syncSliderValue(zSlider, zValue, false, true);

        function forwardKinematics() {
            const t1 = parseFloat(j1Value.value) * Math.PI / 180;
            const t2 = parseFloat(j2Value.value) * Math.PI / 180;
            const x = Math.round(L1 * Math.cos(t1) + L2 * Math.cos(t1 + t2));
            const y = Math.round(L1 * Math.sin(t1) + L2 * Math.sin(t1 + t2));
            xTarget.value = x; yTarget.value = y;
            sendArm({ type: 'joints', j1: j1Value.value, j2: j2Value.value, j3: j3Value.value, z: zValue.value });
        }

        function inverseKinematics(x, y) {
            const d = (x * x + y * y - L1 * L1 - L2 * L2) / (2 * L1 * L2);
            if (Math.abs(d) > 1) return false;
            let theta2 = Math.acos(d);
            if (x < 0 && y < 0) theta2 = -theta2;
            let theta1 = Math.atan2(y, x) - Math.atan2(L2 * Math.sin(theta2), L1 + L2 * Math.cos(theta2));
            theta2 = -theta2 * 180 / Math.PI;
            theta1 = theta1 * 180 / Math.PI;

            if (x >= 0 && y >= 0) theta1 = 90 - theta1;
            else if (x < 0 && y > 0) theta1 = 90 - theta1;
            else if (x < 0 && y < 0) theta1 = 270 - theta1;
            else if (x > 0 && y < 0) theta1 = -90 - theta1;

            j1Value.value = Math.round(theta1); j1Slider.value = j1Value.value;
            j2Value.value = Math.round(theta2); j2Slider.value = j2Value.value;
            return true;
        }

        xTarget.addEventListener('change', () => yTarget.dispatchEvent(new Event('change')));
        yTarget.addEventListener('change', () => {
            const x = parseFloat(xTarget.value), y = parseFloat(yTarget.value);
            if (!isNaN(x) && !isNaN(y)) inverseKinematics(x, y);
        });
        zTarget.addEventListener('change', () => { zValue.value = zTarget.value; zSlider.value = zTarget.value; });

        gripperSlider.addEventListener('input', () => {
            gripperValue.textContent = gripperSlider.value + '%';
            const phi = Math.round(gripperSlider.value * 1.8 - 90);
            j3Value.value = phi; j3Slider.value = phi;
            if (gripperToggle.classList.contains('active')) {
                sendArm({ type: 'gripper', force: gripperSlider.value });
            }
        });

        moveBtn.addEventListener('click', () => {
            sendArm({ type: 'move', x: parseFloat(xTarget.value), y: parseFloat(yTarget.value), z: parseFloat(zTarget.value), speed: parseFloat(armSpeed.value), accel: parseFloat(armAccel.value) });
        });

        gripperToggle.addEventListener('click', () => {
            const on = gripperToggle.classList.toggle('active');
            gripperToggle.querySelector('img').src = on ? 'misc/vortex.png' : 'misc/stop.svg';
            sendArm({ type: 'gripper', state: on ? 'on' : 'off', force: gripperSlider.value });
        });

        window.adjustJoint = function (joint, d) {
            const input = document.getElementById(joint + 'Value');
            let v = parseInt(input.value) + d;
            const min = joint === 'j3' ? -90 : -180;
            const max = joint === 'j3' ? 90 : 180;
            v = Math.max(min, Math.min(max, v));
            input.value = v;
            document.getElementById(joint + 'Slider').value = v;
            if (joint === 'j3') {
                const force = Math.round((v + 90) / 1.8);
                gripperSlider.value = force;
                gripperValue.textContent = force + '%';
            }
            forwardKinematics();
        };

        function sendArm(data) { fetch('/arm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).catch(() => { }); }

        // === ДОЗАТОР ===
        const dosePlus = document.getElementById('dosePlus');
        const doseMinus = document.getElementById('doseMinus');
        const doseVolume = document.getElementById('doseVolume');
        const doseDelta = document.getElementById('doseDelta');
        const doseWash = document.getElementById('doseWash');
        const doseIntake = document.getElementById('doseIntake');
        const doseReset = document.getElementById('doseReset');
        const pumpToggle = document.getElementById('pumpToggle');
        const pumpReverse = document.getElementById('pumpReverse');
        let pumpOn = false, pumpReverseOn = false;

        dosePlus.addEventListener('click', () => {
            const delta = parseInt(doseDelta.value) || 1;
            let vol = parseInt(doseVolume.value) || 0;
            vol += delta;
            doseVolume.value = vol;
            sendDose('dose_plus', vol);
        });
        doseMinus.addEventListener('click', () => {
            const delta = parseInt(doseDelta.value) || 1;
            let vol = parseInt(doseVolume.value) || 0;
            vol = Math.max(0, vol - delta);
            doseVolume.value = vol;
            sendDose('dose_minus', vol);
        });

        doseWash.addEventListener('click', () => sendDose('wash'));
        doseIntake.addEventListener('click', () => sendDose('intake'));
        doseReset.addEventListener('click', () => sendDose('reset_pressure'));

        pumpToggle.addEventListener('click', () => {
            pumpOn = !pumpOn;
            pumpToggle.classList.toggle('active', pumpOn);
            pumpToggle.innerHTML = pumpOn
                ? `<img src="misc/vortex.png" alt="ON"> PUMP ON`
                : `<img src="misc/stop.svg" alt="OFF"> PUMP OFF`;
            sendDose('pump', pumpOn ? 'on' : 'off');
        });

        pumpReverse.addEventListener('click', () => {
            pumpReverseOn = !pumpReverseOn;
            pumpReverse.classList.toggle('active', pumpReverseOn);
            sendDose('reverse', pumpReverseOn);
        });

        function sendDose(action, value = null) {
            fetch('/dose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, value })
            }).catch(() => { });
        }

        // Инициализация
        forwardKinematics();
        gripperSlider.value = 50;
        gripperValue.textContent = '50%';
        j3Value.value = 0;
        j3Slider.value = 0;
    </script>
</body>

</html>